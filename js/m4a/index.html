<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=750">
    <title>m4a音频解析</title>
    <script type="text/javascript" src="../sea.js"></script>
    <script type="text/javascript" src="../eruda.min.js"></script>
    <script type="text/javascript">
    eruda.init();
    var audioContext = new(AudioContext || WebkitAudioContext)();
    var range = null;
    var nextBuffer = [];
    var info = null;
    var arrayBuffer = null;
    seajs.use(["m4a/m4ainfo.js","common/range"],function(M4A,_range){
        new M4A('../../test/src/test.m4a').init().then(function(_info){
            range = _range;
            info = _info;
            load();
        })
    });
    function load(){
        range('../../test/src/test.m4a', 0, null, { //40K
            onsuccess:function(request){
                arrayBuffer = request.response;
                decode(10,14,function(){
                    play();
                    decode(14,18,function(){
                        decode(18,22,function(){
                            decode(22,26,function(){
                        
                            });
                        });
                    });
                })
            }
        })
    }
    function play(){
        // 用于控制音频的播放
        var bufferSourceNode = audioContext.createBufferSource();
        // 将解码后PCM（设备可直接播放的数据流）流赋值给buffer属性
        bufferSourceNode.buffer = nextBuffer.shift();
        // 将播放节点连接到播放设备
        bufferSourceNode.connect(audioContext.destination);
        // 播放
        bufferSourceNode.start(0);
        var begin = new Date().getTime();
        bufferSourceNode.onended = function() {
            if(nextBuffer.length){
                play();
            }
            console.log('end', new Date().getTime() - begin);
        }
    }
    function decode(_offset,_end,callback){
        var offset = info.getOffsetBySecond(_offset);
        var end = info.getOffsetBySecond(_end);
        var buffer = new ArrayBuffer(end-offset+1+info.meta.byteLength);
        var tmp = new Uint8Array(buffer);
        info.rebuildByTime(_offset, end-offset+1+8);
        tmp.set(new Uint8Array(info.meta),0);
        tmp.set(new Uint8Array(arrayBuffer).slice(offset,end),info.meta.byteLength);

        audioContext.decodeAudioData(buffer, function(buffer) {
            nextBuffer.push(buffer);
            if(callback){
                callback();
            }
        })
    }
    </script>
</head>

</html>
